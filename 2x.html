<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADITYALABKEYS | HD PDF Live</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAheWdYiiEBUHgbokK7kDPjMEEk7fngYQ",
            authDomain: "abhyaslabkeys.firebaseapp.com",
            databaseURL: "https://abhyaslabkeys-default-rtdb.firebaseio.com",
            projectId: "abhyaslabkeys",
            storageBucket: "abhyaslabkeys.firebasestorage.app",
            messagingSenderId: "782150849318",
            appId: "1:782150849318:web:79710f1e99b32644c567e7",
            measurementId: "G-K4FM6QY4HY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'lab_keys');
        window.firebaseDB = { db, dbRef, set, onValue, push, remove, update, ref };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.min.css">
    
    <style>
        :root { --primary: #3b82f6; --secondary: #10b981; --text: #1f2937; --bg: #ffffff; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

        .container { padding: 40px 20px; max-width: 800px; margin: 0 auto; }
        .hero h1 { font-size: 2.8rem; margin: 0; line-height: 1.1; color: var(--primary); }
        #admin-trigger { color: var(--secondary); cursor: pointer; user-select: none; display: inline-block; padding: 5px; }

        .feature-box { background: #f9fafb; padding: 25px; border-radius: 20px; margin: 25px 0; border: 1px solid #f3f4f6; }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 30px 0; min-height: 100px; }
        .card { 
            background: white; padding: 20px; border-radius: 18px; border: 1px solid #e5e7eb;
            transition: transform 0.2s, border 0.2s; cursor: pointer; position: relative;
            will-change: transform;
        }
        .card.selected { border: 2px solid var(--primary); background: #eff6ff; transform: scale(0.98); }
        
        .admin-controls { margin-top: 15px; display: flex; gap: 8px; border-top: 1px solid #eee; padding-top: 12px; }
        .adm-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 11px; }
        .edit-btn { background: #dbeafe; color: #1e40af; }
        .del-btn { background: #fee2e2; color: #b91c1c; }

        .banner { 
            background: linear-gradient(135deg, #3b82f6, #10b981); 
            border-radius: 25px; padding: 45px 25px; color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; box-shadow: 0 15px 30px rgba(59, 130, 246, 0.2);
        }
        #open-btn { 
            display: none; background: white; color: black; padding: 16px 35px; 
            border-radius: 14px; border: none; font-weight: 800; margin-top: 25px; 
            cursor: pointer; width: fit-content;
        }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; }
        .modal-body { background: #334155; width: 100%; height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .close-container { position: absolute; top: 15px; right: 20px; z-index: 4000; }
        .btn-close-minimal { background: transparent; color: #ffffff; border: none; font-size: 38px; font-weight: 200; cursor: pointer; padding: 10px; opacity: 0.7; transition: 0.3s; }

        #pdf-viewer { 
            flex: 1; overflow-y: auto; 
            display: flex; flex-direction: column; align-items: center;
            padding: 80px 0 20px 0; scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .page-container {
            position: relative;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            contain: layout paint; /* Optimization: Keeps rendering local to the page */
        }

        canvas { display: block; width: 100%; height: auto; }

        .textLayer {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
        }

        .modal-footer { padding: 12px; display: flex; gap: 10px; border-top: 1px solid #444; background: #1e293b; }
        .btn-foot { flex: 1; border: none; padding: 14px; border-radius: 10px; font-weight: 800; cursor: pointer; }

        @media (max-width: 500px) { .grid { grid-template-columns: 1fr; } .hero h1 { font-size: 2.2rem; } }
    </style>
</head>
<body>

<div class="container">
    <div class="hero">
        <h1>Abhyas<br><span id="admin-trigger">Lab Keys</span></h1>
        <p style="color:#6b7280; font-weight: 500;">Cloud-Synced HD Repository.</p>
    </div>

    <div class="feature-box">
        <ul style="list-style:none; padding:0; margin: 0; font-weight: 600;">
            <li>✦ Ultra-Sharp HD Text Rendering</li>
            <li style="margin: 10px 0;">✦ Full Screen & Copy Support</li>
            <li>✦ Fluid Smooth-Scroll Experience</li>
        </ul>
    </div>

    <div id="loading-text" style="text-align:center; color:gray; padding: 20px;">Connecting...</div>
    <div class="grid" id="main-grid"></div>

    <div class="banner">
        <h2 style="margin:0; font-size: 1.8rem;">View Lab Work</h2>
        <p id="label" style="font-weight: 500; opacity: 0.9;">Choose a category to start</p>
        <button id="open-btn" onclick="openPDF()">Open Program →</button>
    </div>
</div>

<div id="pdf-modal" class="modal">
    <div class="modal-body" id="fullscreen-target">
        <div class="close-container">
            <button class="btn-close-minimal" onclick="closePDF()">✕</button>
        </div>
        <div id="pdf-viewer"></div>
        <div class="modal-footer">
            <button class="btn-foot" style="background:#475569; color:white;" onclick="toggleFS()">⛶ Full Screen</button>
            <button class="btn-foot" style="background:#ef4444; color:white;" onclick="closePDF()">Close</button>
        </div>
    </div>
</div>

<script>
    let currentData = {};
    let selectedKey = null;
    let clickCount = 0;
    let isAdmin = false;

    // Admin Access
    document.getElementById('admin-trigger').onclick = () => {
        clickCount++;
        if(clickCount === 5) {
            if(prompt("Admin Password:") === "adcrjy@123") {
                isAdmin = true;
                alert("Admin Access Granted.");
                render();
            }
            clickCount = 0;
        }
    };

    // Database Initialization
    window.onload = () => {
        const checkFB = setInterval(() => {
            if(window.firebaseDB) {
                clearInterval(checkFB);
                const { dbRef, onValue } = window.firebaseDB;
                onValue(dbRef, (snapshot) => {
                    currentData = snapshot.val() || {};
                    document.getElementById('loading-text').style.display = 'none';
                    render();
                });
            }
        }, 100);
    };

    // Optimized Render (Uses DocumentFragment to prevent UI freezing)
    function render() {
        const grid = document.getElementById('main-grid');
        const fragment = document.createDocumentFragment();

        if(isAdmin) {
            const addCard = document.createElement('div');
            addCard.className = 'card';
            addCard.style.cssText = "border:2px dashed #ccc; text-align:center;";
            addCard.innerHTML = "<strong>+ Add Window</strong>";
            addCard.onclick = addWindow;
            fragment.appendChild(addCard);
        }

        Object.keys(currentData).forEach((key) => {
            const item = currentData[key];
            const card = document.createElement('div');
            card.className = `card ${selectedKey === key ? 'selected' : ''}`;
            card.id = `card-${key}`;
            
            card.onclick = () => { 
                selectedKey = key; 
                document.getElementById('open-btn').style.display = 'block'; 
                document.getElementById('label').innerText = "Selected: " + item.name;
                
                // Visual feedback without full re-render
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            };

            card.innerHTML = `<strong>${item.name}</strong><p style="font-size:12px; color:var(--primary); font-weight:700; margin-top:5px;">VIEW FILE</p>`;
            
            if(isAdmin) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                controls.innerHTML = `<button class="adm-btn edit-btn">Edit</button><button class="adm-btn del-btn">Delete</button>`;
                controls.querySelector('.edit-btn').onclick = (e) => { e.stopPropagation(); editWindow(key); };
                controls.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); deleteWindow(key); };
                card.appendChild(controls);
            }
            fragment.appendChild(card);
        });

        grid.innerHTML = '';
        grid.appendChild(fragment);
    }

    // High Quality PDF Rendering with "Breathing Room" for Scroll
    async function openPDF() {
        const item = currentData[selectedKey];
        const modal = document.getElementById('pdf-modal');
        const view = document.getElementById('pdf-viewer');
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; 
        view.innerHTML = '<p style="color:white; padding:20px;">Loading HD Pages...</p>';

        try {
            const doc = await pdfjsLib.getDocument(item.link).promise;
            view.innerHTML = ''; // Clear loading text

            const viewerWidth = view.clientWidth;
            const outputScale = window.devicePixelRatio || 2; 

            for(let n=1; n<=doc.numPages; n++) {
                // Pause every page for 50ms to allow browser to handle touch/scroll
                await new Promise(r => setTimeout(r, 50));

                const page = await doc.getPage(n);
                const unscaledViewport = page.getViewport({scale: 1});
                const fitScale = (viewerWidth - 30) / unscaledViewport.width;
                const viewport = page.getViewport({scale: fitScale});

                const container = document.createElement('div');
                container.className = 'page-container';
                container.style.width = viewport.width + 'px';
                container.style.height = viewport.height + 'px';

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);
                canvas.style.width = viewport.width + "px";
                canvas.style.height = viewport.height + "px";

                container.appendChild(canvas);
                view.appendChild(container);

                await page.render({
                    canvasContext: context, 
                    viewport: viewport,
                    transform: [outputScale, 0, 0, outputScale, 0, 0]
                }).promise;

                // Add text layer for copy-paste after image renders
                const textContent = await page.getTextContent();
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                container.appendChild(textLayerDiv);
                pdfjsLib.renderTextLayer({ textContent, container: textLayerDiv, viewport, textDivs: [] });
            }
        } catch (err) { view.innerHTML = '<p style="color:red; padding:20px;">Render failed. Link may be broken.</p>'; }
    }

    function toggleFS() {
        const target = document.getElementById('fullscreen-target');
        if (!document.fullscreenElement) target.requestFullscreen().catch(() => alert("Not supported."));
        else document.exitFullscreen();
    }

    function addWindow() {
        const name = prompt("Name:");
        const link = prompt("Direct PDF Link:");
        if(name && link) window.firebaseDB.push(window.firebaseDB.dbRef, { name, link });
    }

    function editWindow(key) {
        const n = prompt("New Name:", currentData[key].name);
        const l = prompt("New Link:", currentData[key].link);
        if(n && l) window.firebaseDB.update(window.firebaseDB.ref(window.firebaseDB.db, 'lab_keys/' + key), { name: n, link: l });
    }

    function deleteWindow(key) {
        if(confirm("Delete from Cloud?")) window.firebaseDB.remove(window.firebaseDB.ref(window.firebaseDB.db, 'lab_keys/' + key));
    }

    function closePDF() { 
        if (document.fullscreenElement) document.exitFullscreen();
        document.getElementById('pdf-modal').style.display = 'none'; 
        document.body.style.overflow = 'auto'; 
    }
</script>

</body>
</html>
